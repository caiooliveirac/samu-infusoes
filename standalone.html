<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMU Infus√µes (Standalone)</title>
    <style>
        :root {
            --slate-950: #020617;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            
            --cyan-950: #083344;
            --cyan-500: #06b6d4;
            --cyan-400: #22d3ee;
            --cyan-200: #a5f3fc;

            --rose-400: #fb7185;
            --amber-400: #fbbf24;
            --purple-400: #c084fc;
            --emerald-400: #34d399;
            --blue-400: #60a5fa;
            --gray-400: #9ca3af;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, sans-serif;
            background-color: var(--slate-950);
            color: var(--slate-50);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 5rem;
        }

        header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { font-size: 1.25rem; font-weight: 700; margin: 0; }
        .text-cyan { color: var(--cyan-400); }
        .version {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--slate-500);
            background: var(--slate-900);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        /* Inputs */
        .input-group {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .input-wrapper { position: relative; }

        input {
            width: 100%;
            background: var(--slate-900);
            border: 1px solid var(--slate-800);
            color: var(--slate-100);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus { border-color: var(--cyan-500); }
        input[type="number"] { text-align: center; font-family: monospace; font-weight: bold; color: var(--cyan-400); }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--slate-500);
            pointer-events: none;
        }
        .search-input { padding-left: 2.5rem; }

        .suffix {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: var(--slate-500);
            pointer-events: none;
        }

        /* Categories */
        .categories {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            /* Hide scrollbar */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .categories::-webkit-scrollbar { display: none; }

        .cat-btn {
            background: var(--slate-900);
            color: var(--slate-400);
            border: 1px solid var(--slate-800);
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cat-btn.active {
            background: var(--cyan-500);
            color: white;
            border-color: var(--cyan-500);
        }

        /* Drug List */
        .drug-list { display: flex; flex-direction: column; gap: 0.75rem; }

        .card {
            background: var(--slate-900);
            border: 1px solid var(--slate-800);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.2s;
        }
        .card.expanded {
            border-color: var(--cyan-500);
            box-shadow: 0 0 0 1px var(--cyan-500), 0 10px 15px -3px rgba(8, 51, 68, 0.2);
        }

        .card-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header:hover { background: rgba(30, 41, 59, 0.5); }

        .card-content { display: none; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-top: 1px solid var(--slate-800); }
        .card.expanded .card-content { display: block; animation: slideDown 0.2s ease-out; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .badge {
            display: inline-block;
            font-size: 0.625rem;
            text-transform: uppercase;
            font-weight: bold;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            border: 1px solid;
            margin-bottom: 0.25rem;
        }
        
        .type-vasopressor { color: var(--rose-400); border-color: rgba(251, 113, 133, 0.2); background: rgba(251, 113, 133, 0.1); }
        .type-inotropos { color: var(--amber-400); border-color: rgba(251, 191, 36, 0.2); background: rgba(251, 191, 36, 0.1); }
        .type-sedativo { color: var(--purple-400); border-color: rgba(192, 132, 252, 0.2); background: rgba(192, 132, 252, 0.1); }
        .type-vasodilatador { color: var(--emerald-400); border-color: rgba(52, 211, 153, 0.2); background: rgba(52, 211, 153, 0.1); }
        .type-antiarritmico { color: var(--blue-400); border-color: rgba(96, 165, 250, 0.2); background: rgba(96, 165, 250, 0.1); }
        .type-outros { color: var(--gray-400); border-color: rgba(156, 163, 175, 0.2); background: rgba(156, 163, 175, 0.1); }

        .drug-name { font-weight: bold; color: var(--slate-100); }

        .preview-rate {
            margin-top: 0.5rem;
            display: flex;
            align-items: baseline;
            gap: 0.25rem;
        }
        .preview-val { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: var(--cyan-400); line-height: 1; }
        .preview-unit { font-size: 0.75rem; color: rgba(34, 211, 238, 0.7); font-weight: 500; }

        .info-grid {
            background: rgba(2, 6, 23, 0.5);
            border: 1px solid rgba(30, 41, 59, 0.5);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin: 1rem 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--slate-400);
        }
        .info-label { display: block; color: var(--slate-500); margin-bottom: 0.125rem; }
        .info-val { font-family: monospace; color: var(--slate-300); }
        .info-full { grid-column: 1 / -1; padding-top: 0.5rem; border-top: 1px solid var(--slate-800); margin-top: 0.25rem; }

        .dose-input-wrapper { margin-bottom: 1rem; }
        .dose-label { display: block; font-size: 0.75rem; font-weight: 500; color: var(--slate-400); text-transform: uppercase; margin-bottom: 0.375rem; }

        .result-box {
            background: rgba(8, 51, 68, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-label { font-size: 0.875rem; font-weight: 500; color: rgba(165, 243, 252, 0.7); text-transform: uppercase; }
        .result-val { font-family: monospace; font-size: 2rem; font-weight: bold; color: var(--cyan-400); }
        .result-unit { font-size: 1rem; color: rgba(6, 182, 212, 0.7); margin-left: 0.25rem; }

        footer { text-align: center; margin-top: 2rem; font-size: 0.625rem; color: var(--slate-600); line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><span class="text-cyan">SAMU</span> 192 Infus√µes</h1>
        <div class="version">v1.0 (Standalone)</div>
    </header>

    <div class="input-group">
        <div class="input-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Busca..." autocomplete="off">
        </div>
        <div class="input-wrapper">
            <input type="number" id="weightInput" placeholder="KG" value="70">
            <span class="suffix">kg</span>
        </div>
    </div>

    <div class="categories" id="categoriesContainer">
        <!-- JS fills this -->
    </div>

    <div class="drug-list" id="drugList">
        <!-- JS fills this -->
    </div>

    <footer>
        USO EXCLUSIVO PARA PROFISSIONAIS DE SA√öDE.<br>
        Conferir sempre as dilui√ß√µes e doses antes da administra√ß√£o.<br>
        O desenvolvedor n√£o se responsabiliza pelo uso indevido.
    </footer>
</div>

<script>
// --- DATASOURCE ---
const DRUGS = [
  {
    "id": "adrenalina_cloridrat_1",
    "name": "ADRENALINA, CLORIDRATO",
    "type": "vasopressor",
    "presentation": { "ampoule_ml": 1.0, "mg_ml": 1.0 },
    "standard_dilution": { "syringe_ml": 20.0, "num_ampoules": 1.0, "drug_volume_ml": 1.0, "diluent_volume_ml": 19.0, "final_concentration_mcg_ml": 50.0 },
    "default_dose": { "min": 0.0476, "max": 0.2024, "unit": "mcg/kg/min" }
  },
  {
    "id": "amiodarona_ataque_1",
    "name": "AMIODARONA (ataque)",
    "type": "antiarritmico",
    "presentation": { "ampoule_ml": 3.0, "mg_ml": 50.0 },
    "standard_dilution": { "syringe_ml": 20.0, "num_ampoules": 1.0, "drug_volume_ml": 3.0, "diluent_volume_ml": 17.0, "final_concentration_mcg_ml": 7500.0 },
    "default_dose": { "min": null, "max": null, "unit": "mcg/kg/h" }
  },
  {
    "id": "amiodarona_manutencao_1",
    "name": "AMIODARONA (manuten√ß√£o - 6 horas)",
    "type": "antiarritmico",
    "presentation": { "ampoule_ml": 3.0, "mg_ml": 50.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 6.0, "drug_volume_ml": 18.0, "diluent_volume_ml": 32.0, "final_concentration_mcg_ml": 9000.0 },
    "default_dose": { "min": 7.1429, "max": 14.2857, "unit": "mcg/kg/min" }
  },
  {
    "id": "atropina_sulfato_1",
    "name": "ATROPINA, SULFATO",
    "type": "outros",
    "presentation": { "ampoule_ml": 1.0, "mg_ml": 0.25 },
    "standard_dilution": { "syringe_ml": 20.0, "num_ampoules": 20.0, "drug_volume_ml": 20.0, "diluent_volume_ml": 0.0, "final_concentration_mcg_ml": 250.0 },
    "default_dose": { "min": 0.04, "max": 0.1, "unit": "mcg/kg/min" }
  },
  {
    "id": "dobutamina_cloridrat_1",
    "name": "DOBUTAMINA, CLORIDRATO",
    "type": "inotropos",
    "presentation": { "ampoule_ml": 20.0, "mg_ml": 12.5 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 1.0, "drug_volume_ml": 20.0, "diluent_volume_ml": 30.0, "final_concentration_mcg_ml": 5000.0 },
    "default_dose": { "min": 2.0, "max": 20.0, "unit": "mcg/kg/min" }
  },
  {
    "id": "dobutamina_cloridrat_2",
    "name": "DOBUTAMINA, CLORIDRATO (Equiv Concentrada)",
    "type": "inotropos",
    "presentation": { "ampoule_ml": 20.0, "mg_ml": 12.5 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 2.0, "drug_volume_ml": 40.0, "diluent_volume_ml": 10.0, "final_concentration_mcg_ml": 10000.0 },
    "default_dose": { "min": 2.0, "max": 20.0, "unit": "mcg/kg/min" }
  },
  {
    "id": "dobutamina_cloridrat_3",
    "name": "DOBUTAMINA, CLORIDRATO (Equiv 4X Concentrada)",
    "type": "inotropos",
    "presentation": { "ampoule_ml": 20.0, "mg_ml": 12.5 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 4.0, "drug_volume_ml": 80.0, "diluent_volume_ml": 0.0, "final_concentration_mcg_ml": 20000.0 },
    "default_dose": { "min": 2.0, "max": 20.0, "unit": "mcg/kg/min" }
  },
  {
    "id": "dopamina_cloridrato_1",
    "name": "DOPAMINA, CLORIDRATO",
    "type": "vasopressor",
    "presentation": { "ampoule_ml": 10.0, "mg_ml": 5.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 4.0, "drug_volume_ml": 40.0, "diluent_volume_ml": 10.0, "final_concentration_mcg_ml": 4000.0 },
    "default_dose": { "min": 2.0, "max": 20.0, "unit": "mcg/kg/min" }
  },
  {
    "id": "fentanila_citrato_1",
    "name": "FENTANILA, CITRATO",
    "type": "sedativo",
    "presentation": { "ampoule_ml": 10.0, "mg_ml": 0.05 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 1.0, "drug_volume_ml": 10.0, "diluent_volume_ml": 40.0, "final_concentration_mcg_ml": 10.0 },
    "default_dose": { "min": 0.5, "max": 2.0, "unit": "mcg/kg/h" }
  },
  {
    "id": "fentanila_citrato_2",
    "name": "FENTANILA, CITRATO (Concentrada)",
    "type": "sedativo",
    "presentation": { "ampoule_ml": 10.0, "mg_ml": 0.05 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 5.0, "drug_volume_ml": 50.0, "diluent_volume_ml": 0.0, "final_concentration_mcg_ml": 50.0 },
    "default_dose": { "min": 0.5, "max": 2.0, "unit": "mcg/kg/h" }
  },
  {
    "id": "midazolam_sedacao_1",
    "name": "MIDAZOLAM (Seda√ß√£o)",
    "type": "sedativo",
    "presentation": { "ampoule_ml": 10.0, "mg_ml": 5.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 1.0, "drug_volume_ml": 10.0, "diluent_volume_ml": 40.0, "final_concentration_mcg_ml": 1000.0 },
    "default_dose": { "min": 20.0, "max": 100.0, "unit": "mcg/kg/h" }
  },
  {
    "id": "midazolam_sedacao_2",
    "name": "MIDAZOLAM (Seda√ß√£o Concentrada)",
    "type": "sedativo",
    "presentation": { "ampoule_ml": 10.0, "mg_ml": 5.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 5.0, "drug_volume_ml": 50.0, "diluent_volume_ml": 0.0, "final_concentration_mcg_ml": 5000.0 },
    "default_dose": { "min": 20.0, "max": 100.0, "unit": "mcg/kg/h" }
  },
  {
    "id": "noradrenalina_hemitartarato_1",
    "name": "NORADRENALINA (Hemitartarato)",
    "type": "vasopressor",
    "presentation": { "ampoule_ml": 4.0, "mg_ml": 1.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 4.0, "drug_volume_ml": 16.0, "diluent_volume_ml": 34.0, "final_concentration_mcg_ml": 320.0 },
    "default_dose": { "min": 0.05, "max": 2.0, "unit": "mcg/kg/min" }
  },
  {
    "id": "noradrenalina_hemitartarato_neo_1",
    "name": "NORADRENALINA (Neonatal/Ped - 16mcg/ml)",
    "type": "vasopressor",
    "presentation": { "ampoule_ml": 4.0, "mg_ml": 1.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 1.0, "drug_volume_ml": 0.8, "diluent_volume_ml": 49.2, "final_concentration_mcg_ml": 16.0 },
    "default_dose": { "min": 0.05, "max": 2.0, "unit": "mcg/kg/min" }
  },
  {
    "id": "nitroglicerina_sca_1",
    "name": "NITROGLICERINA (SCA)",
    "type": "vasodilatador",
    "presentation": { "ampoule_ml": 10.0, "mg_ml": 5.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 2.0, "drug_volume_ml": 20.0, "diluent_volume_ml": 30.0, "final_concentration_mcg_ml": 2000.0 },
    "default_dose": { "min": 5.0, "max": 200.0, "unit": "mcg/min" }
  },
  {
    "id": "nitroprussiato_sodio_1",
    "name": "NITROPRUSSIATO DE S√ìDIO",
    "type": "vasodilatador",
    "presentation": { "ampoule_ml": 2.0, "mg_ml": 25.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 1.0, "drug_volume_ml": 2.0, "diluent_volume_ml": 48.0, "final_concentration_mcg_ml": 1000.0 },
    "default_dose": { "min": 0.25, "max": 10.0, "unit": "mcg/kg/min" }
  },
  {
    "id": "propofol_1_1",
    "name": "PROPOFOL 1%",
    "type": "sedativo",
    "presentation": { "ampoule_ml": 20.0, "mg_ml": 10.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 2.0, "drug_volume_ml": 40.0, "diluent_volume_ml": 0.0, "final_concentration_mcg_ml": 10000.0 },
    "default_dose": { "min": 5.0, "max": 50.0, "unit": "mcg/kg/min" }
  },
  {
    "id": "cetamina_cloridrato_1",
    "name": "CETAMINA CLORIDRATO (Manuten√ß√£o)",
    "type": "sedativo",
    "presentation": { "ampoule_ml": 10.0, "mg_ml": 50.0 },
    "standard_dilution": { "syringe_ml": 50.0, "num_ampoules": 1.0, "drug_volume_ml": 10.0, "diluent_volume_ml": 40.0, "final_concentration_mcg_ml": 10000.0 },
    "default_dose": { "min": 5.0, "max": 20.0, "unit": "mcg/kg/min" }
  }
];

const CATEGORIES = [
    { id: 'all', label: 'Todos' },
    { id: 'vasopressor', label: 'Vasopressores' },
    { id: 'sedativo', label: 'Sedativos' },
    { id: 'inotropos', label: 'Inotr√≥picos' },
    { id: 'vasodilatador', label: 'Vasodilatadores' },
    { id: 'antiarritmico', label: 'Antiarritmicos' },
    { id: 'outros', label: 'Outros' }
];

// --- STATE MANAGMENT ---
let state = {
    weight: 70,
    search: '',
    category: 'all',
    expandedCards: new Set(),
    doses: {} // Map drugId -> value
};

// --- DOM ELEMENTS ---
const searchInput = document.getElementById('searchInput');
const weightInput = document.getElementById('weightInput');
const categoriesContainer = document.getElementById('categoriesContainer');
const drugList = document.getElementById('drugList');

// --- EVENT LISTENERS ---
weightInput.addEventListener('input', (e) => {
    state.weight = parseFloat(e.target.value) || 0;
    renderRateUpdates(); // Opitmization: don't re-render full list, just rates
});

searchInput.addEventListener('input', (e) => {
    state.search = e.target.value;
    renderDrugList();
});

// --- RENDER CATEGORIES ---
function renderCategories() {
    categoriesContainer.innerHTML = '';
    CATEGORIES.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = `cat-btn ${state.category === cat.id ? 'active' : ''}`;
        btn.textContent = cat.label;
        btn.onclick = () => {
            state.category = cat.id;
            renderCategories(); // Re-render self to update active class
            renderDrugList();
        };
        categoriesContainer.appendChild(btn);
    });
}

// --- UTILS ---
function formatNumber(num) {
    if (num === 0) return '0';
    if (num < 0.1) return num.toFixed(2);
    if (num < 10) return num.toFixed(1);
    return Math.round(num).toString();
}

function calculateRate(dose, weight, drug) {
    const concentration = drug.standard_dilution.final_concentration_mcg_ml;
    const unit = drug.default_dose.unit;

    if (concentration === 0) return 0;
    if (unit === 'mcg/kg/min') {
        if (!weight) return 0;
        return (dose * weight * 60) / concentration;
    }
    if (unit === 'mcg/kg/h') {
        if (!weight) return 0;
        return (dose * weight) / concentration;
    }
    if (unit === 'mcg/min') {
        return (dose * 60) / concentration;
    }
    if (unit === 'mcg/h') {
        return dose / concentration;
    }
    return 0;
}

// --- RENDER DRUGS ---
function renderDrugList() {
    drugList.innerHTML = '';
    
    const filtered = DRUGS.filter(d => {
        const matchSearch = d.name.toLowerCase().includes(state.search.toLowerCase()) || 
                            d.type.toLowerCase().includes(state.search.toLowerCase());
        const matchCat = state.category === 'all' || d.type === state.category;
        return matchSearch && matchCat;
    });

    if (filtered.length === 0) {
        drugList.innerHTML = '<div style="text-align:center; color:var(--slate-500); padding:2rem;">Nenhuma droga encontrada.</div>';
        return;
    }

    filtered.forEach(drug => {
        const card = document.createElement('div');
        card.className = `card ${state.expandedCards.has(drug.id) ? 'expanded' : ''}`;
        card.id = `card-${drug.id}`;
        
        // Initialize dose defaults if needed
        if (state.doses[drug.id] === undefined) {
             state.doses[drug.id] = drug.default_dose.min || 0;
        }

        const isExpanded = state.expandedCards.has(drug.id);
        const currentDose = state.doses[drug.id];
        const rate = calculateRate(currentDose, state.weight, drug);

        card.innerHTML = `
            <div class="card-header" onclick="toggleCard('${drug.id}')">
                <div>
                    <span class="badge type-${drug.type}">${drug.type}</span>
                    <div class="drug-name">${drug.name}</div>
                    ${!isExpanded && rate > 0 ? `
                        <div class="preview-rate">
                            <span class="preview-val">${formatNumber(rate)}</span>
                            <span class="preview-unit">mL/h</span>
                        </div>
                    ` : ''}
                </div>
                <div style="color: var(--slate-500)">${isExpanded ? '‚ñ≤' : '‚ñº'}</div>
            </div>
            <div class="card-content">
                <div class="info-grid">
                    <div>
                        <span class="info-label">Seringa Total</span>
                        <span class="info-val">${drug.standard_dilution.syringe_ml} mL</span>
                    </div>
                    <div>
                        <span class="info-label">Concentra√ß√£o</span>
                        <span class="info-val">${drug.standard_dilution.final_concentration_mcg_ml} mcg/mL</span>
                    </div>
                    <div class="info-full">
                        <span class="info-label">Preparo</span>
                        <span class="info-val">
                             ${drug.standard_dilution.drug_volume_ml}mL Droga + ${drug.standard_dilution.diluent_volume_ml}mL Diluente
                        </span>
                    </div>
                    ${drug.standard_dilution.num_ampoules ? `
                        <div class="info-full">
                             <span class="info-label">Ampolas</span>
                             <span class="info-val">${drug.standard_dilution.num_ampoules} amp</span>
                        </div>
                    ` : ''}
                </div>

                <div class="dose-input-wrapper">
                    <label class="dose-label">Dose Prescrita</label>
                    <div class="input-wrapper">
                        <input type="number" 
                               value="${currentDose}" 
                               oninput="updateDose('${drug.id}', this.value)"
                               step="0.01"
                        >
                        <span class="suffix">${drug.default_dose.unit}</span>
                    </div>
                </div>

                ${rate > 0 ? `
                    <div class="result-box">
                        <span class="result-label">Vaz√£o Bomba</span>
                        <div>
                            <span class="result-val">${formatNumber(rate)}</span>
                            <span class="result-unit">mL/h</span>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;

        drugList.appendChild(card);
    });
}

// --- ACTIONS ---
window.toggleCard = (id) => {
    if (state.expandedCards.has(id)) {
        state.expandedCards.delete(id);
    } else {
        state.expandedCards.add(id);
    }
    renderDrugList(); // Re-render to show animation/expansion
};

window.updateDose = (id, value) => {
    state.doses[id] = parseFloat(value);
    // Only re-render if we really need to, but simpler to just re-render list or specific card
    // For Vanilla JS simplicity, we'll re-render the whole list to keep state sync easy, 
    // but in a larger app we would target specific elements. 
    // Optimization: Just update the result box if it exists.
    
    // Quick Hack used: Re-rendering causes input focus loss.
    // Solution: Don't re-render full HTML. Calculate and update DOM directly.
    
    const drug = DRUGS.find(d => d.id === id);
    if(!drug) return;

    const rate = calculateRate(state.doses[id], state.weight, drug);
    const card = document.getElementById(`card-${id}`);
    
    // Update Result Box
    const resultBox = card.querySelector('.result-box');
    
    if (rate > 0) {
        const resultHTML = `
            <span class="result-label">Vaz√£o Bomba</span>
            <div>
                <span class="result-val">${formatNumber(rate)}</span>
                <span class="result-unit">mL/h</span>
            </div>
        `;
        
        if (resultBox) {
            resultBox.innerHTML = resultHTML;
        } else {
            // Need to insert it
            const newBox = document.createElement('div');
            newBox.className = 'result-box';
            newBox.innerHTML = resultHTML;
            card.querySelector('.card-content').appendChild(newBox);
        }
    } else {
        if (resultBox) resultBox.remove();
    }
};

function renderRateUpdates() {
    // Called when weight changes
    DRUGS.forEach(drug => {
        const card = document.getElementById(`card-${drug.id}`);
        if(card && state.expandedCards.has(drug.id)) {
            // Force update calculation
            window.updateDose(drug.id, state.doses[drug.id] || 0);
        } else if (card) {
             // Update preview if collapsed
             // Can't easily update preview without re-render or complex selection
             // Let's just re-render list for weight change since focus isn't an issue usually on weight input
        }
    });
    renderDrugList(); // Simplest for weight change
}


// --- INIT ---
renderCategories();
renderDrugList();

</script>
</body>
</html>

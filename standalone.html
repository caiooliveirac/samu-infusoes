<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMU 192 (Auditado - Standalone v2)</title>
    <style>
        :root {
            /* INSTITUTIONAL THEME */
            --bg-body: #f8fafc; /* Slate 50 */
            --bg-card: #ffffff;
            --text-main: #0f172a; /* Slate 900 */
            --text-muted: #64748b; /* Slate 500 */
            
            --samu-red: #dc2626; /* Red 600 */
            --samu-red-dark: #b91c1c; /* Red 700 */
            --samu-orange: #ea580c; /* Orange 600 */
            --samu-orange-light: #fff7ed; /* Orange 50 */
            
            --border-color: #e2e8f0; /* Slate 200 */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            
            /* High Dose Alert Colors */
            --alert-bg: #fff7ed; /* Orange 50 */
            --alert-text: #c2410c; /* Orange 700 */
            --alert-border: #fed7aa; /* Orange 200 */
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 5rem;
        }

        /* HEADER */
        header {
            background-color: var(--samu-red);
            color: white;
            padding: 1.5rem 1rem;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        h1 { font-size: 1.5rem; font-weight: 800; margin: 0; letter-spacing: -0.025em; text-transform: uppercase; display: flex; align-items: center; gap: 0.5rem; }
        .subtitle { font-size: 0.75rem; opacity: 0.9; font-weight: 400; border-left: 1px solid rgba(255,255,255,0.3); padding-left: 0.5rem; }

        /* INPUTS GLOBAL */
        .controls {
            display: flex;
            gap: 0.75rem;
        }

        .input-wrapper { position: relative; flex: 1; }
        
        input {
            width: 100%;
            height: 3rem;
            padding: 0 1rem;
            border-radius: 0.5rem;
            border: 2px solid transparent;
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
            outline: none;
            color: var(--text-main);
        }
        input:focus { border-color: var(--samu-orange); }

        .search-input { padding-left: 2.5rem; }
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .weight-wrapper { width: 5.5rem; flex: none; }
        .weight-input { text-align: center; font-weight: 700; padding: 0 1.5rem 0 0.5rem; }
        .weight-suffix {
            position: absolute;
            right: 0.5rem;
            top: 0.25rem;
            font-size: 0.6rem;
            font-weight: 700;
            color: var(--text-muted);
            pointer-events: none;
            text-transform: uppercase;
        }

        /* TOGGLE */
        .toggle-container {
            margin-top: 0.75rem;
            background: rgba(0,0,0,0.1);
            padding: 0.25rem;
            border-radius: 0.5rem;
            display: flex;
        }
        .toggle-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.7);
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: white;
            color: var(--samu-red);
            box-shadow: var(--shadow-sm);
        }

        /* MAIN LIST */
        .drug-list { padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .card.expanded {
            border-color: var(--samu-orange);
            box-shadow: var(--shadow-md);
            outline: 2px solid rgba(234, 88, 12, 0.1);
        }

        .card-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header:active { background-color: var(--bg-body); }

        .badge {
            display: inline-block;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 700;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            letter-spacing: 0.025em;
        }

        /* Theme Colors for badges */
        .badge.vasopressor { background: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
        .badge.inotropos { background: #fef9c3; color: #a16207; border: 1px solid #fde047; }
        .badge.sedativo { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; }
        .badge.vasodilatador { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .badge.antiarritmico { background: #dbeafe; color: #1d4ed8; border: 1px solid #93c5fd; }
        .badge.outros { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }

        .drug-name { font-weight: 700; font-size: 1.125rem; color: var(--text-main); line-height: 1.2; }
        
        .warning-tag {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--samu-red);
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 0.125rem 0.375rem;
            border-radius: 999px;
            margin-left: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .card-content { display: none; background: #f8fafc; border-top: 1px solid var(--border-color); }
        .card.expanded .card-content { display: block; animation: slideDown 0.2s ease-out; }

        /* INFO GRID */
        .info-grid {
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            font-size: 0.75rem;
        }
        .info-box {
            background: white;
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
        .info-label { display: block; color: var(--text-muted); text-transform: uppercase; font-size: 0.65rem; font-weight: 600; margin-bottom: 0.125rem; }
        .info-val { font-family: monospace; font-size: 0.875rem; font-weight: 600; color: var(--text-main); }
        .info-val.large { font-size: 1rem; font-weight: 700; }

        /* CALCULATION AREA */
        .calc-area { padding: 0 1rem 1.5rem 1rem; }
        
        .dose-input-group { background: white; padding: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: var(--shadow-sm); }
        .dose-input { 
            border: 1px solid #cbd5e1; 
            height: 2.5rem; 
            font-family: monospace; 
            font-weight: bold; 
            font-size: 1.125rem;
            color: var(--text-main);
            text-align: center;
        }
        .dose-input:focus { border-color: var(--samu-orange); }
        /* Soft Alert High Dose Style */
        .dose-input.high-dose { border-color: #fdba74; background-color: #fff7ed; color: #c2410c; }
        
        .high-dose-badge {
            display: block;
            margin-top: 0.5rem;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #c2410c;
            background: #fff7ed;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }

        .result-box {
            margin-top: 1rem;
            background: var(--text-main);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; opacity: 0.8; letter-spacing: 0.05em; }
        .result-val { font-family: monospace; font-size: 2.25rem; font-weight: 700; line-height: 1; }
        .result-unit { font-size: 1rem; opacity: 0.8; margin-left: 0.25rem; font-weight: 500; }

        footer { text-align: center; font-size: 0.65rem; color: var(--text-muted); margin-top: 2rem; padding: 0 2rem; text-transform: uppercase; letter-spacing: 0.05em; line-height: 1.5; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .error-state {
            text-align: center;
            padding: 2rem;
            color: var(--samu-red);
            font-size: 0.85rem;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            margin: 1rem;
        }
    </style>
</head>
<body>

<header>
    <div class="container container-header" style="margin:0; min-height:initial; padding:0;">
        <div class="header-content">
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 12a5 5 0 0 1 5-5v0a5 5 0 0 1 5 5v6H7v-6Z"/><path d="M5 20a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2H5v-2Z"/><path d="M12 7v5"/><path d="M12 2v2"/></svg>
                SAMU 192 <span class="subtitle">Protocolos</span>
            </h1>
        </div>

        <div class="controls">
            <div class="input-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Buscar..." autocomplete="off">
            </div>
            <div class="input-wrapper weight-wrapper">
                <input type="number" id="weightInput" class="weight-input" placeholder="KG" value="70">
                <span class="weight-suffix">kg</span>
            </div>
        </div>

        <div class="toggle-container">
            <button class="toggle-btn active" id="btn20ml" onclick="setSyringe(20)">Seringa 20ml</button>
            <button class="toggle-btn" id="btn50ml" onclick="setSyringe(50)">Seringa 50ml</button>
        </div>
    </div>
</header>

<div class="container">
    <div class="drug-list" id="drugList">
        <div class="loading-state">
            Carregando banco de dados...
        </div>
    </div>

    <footer>
        Uso exclusivo para profissionais de sa√∫de.<br>
        Conferir sempre dilui√ß√µes antes da administra√ß√£o.<br>
        v1.3 (Base 94 Itens)
    </footer>
</div>

<script src="src/data/drugs.js"></script>
<script>
// --- DATA LOAD ---
let DRUGS = (typeof DRUGS_DATA !== 'undefined') ? DRUGS_DATA : [];

if (typeof DRUGS_DATA === 'undefined') {
     console.error('DRUGS_DATA not found. Check src/data/drugs.js');
     // DOM might not be fully ready if script is in head? No, it's at end of body.
     setTimeout(() => {
        const list = document.getElementById('drugList');
        if(list) list.innerHTML = '<div class="error-state">Erro: Base de dados (src/data/drugs.js) n√£o carregou.</div>';
     }, 100);
}

// --- STATE ---
let state = {
    weight: 70,
    search: '',
    expandedCards: new Set(),
    doses: {},
    syringeSize: 20
};

// --- DOM ---
const searchInput = document.getElementById('searchInput');
const weightInput = document.getElementById('weightInput');
const drugList = document.getElementById('drugList');

// --- SETUP ---
weightInput.addEventListener('input', (e) => {
    state.weight = parseFloat(e.target.value) || 0;
    renderAllCalculations(); 
});

searchInput.addEventListener('input', (e) => {
    state.search = e.target.value;
    renderDrugList();
});

function setSyringe(size) {
    state.syringeSize = size;
    document.getElementById('btn20ml').classList.toggle('active', size === 20);
    document.getElementById('btn50ml').classList.toggle('active', size === 50);
    renderDrugList();
}

// --- LOGIC ---
function formatNumber(num) {
    if (num === 0) return '0';
    if (!isFinite(num)) return 'Erro';
    if (num < 0.1) return num.toFixed(2);
    if (num < 10) return num.toFixed(1);
    return Math.round(num).toString();
}

function calculateRate(dose, weight, drug) {
    if (!dose || parseFloat(dose) === 0) return 0;
    
    const concentration = drug.standard_dilution.final_concentration_mcg_ml;
    const unit = drug.default_dose.unit;

    if (concentration === 0) return 0;
    
    // Robust calculation based on unit type
    if (unit === 'mcg/kg/min') {
        if (!weight) return 0;
        return (dose * weight * 60) / concentration;
    }
    if (unit === 'mcg/kg/h') {
        if (!weight) return 0;
        return (dose * weight) / concentration;
    }
    if (unit === 'mcg/min') {
        return (dose * 60) / concentration;
    }
    // NOVOS FORMATOS (v1.3)
    if (unit === 'g/h') {
        // 1g = 1,000,000mcg
        return (dose * 1000000) / concentration;
    }
    if (unit === 'mg/dose') {
        // Volume total (n√£o vaz√£o cont√≠nua) - Displayed as "mL/h" (Volume a infundir agora)
        return (dose * 1000) / concentration;
    }
    if (unit === 'mg/kg') {
        // Volume total baseado em peso
        if (!weight) return 0;
        return (dose * weight * 1000) / concentration;
    }
    
    return 0;
}

// --- RENDER ---
function renderDrugList() {
    drugList.innerHTML = '';
    
    if (DRUGS.length === 0) {
        drugList.innerHTML = '<div class="loading-state">Carregando...</div>';
        return;
    }
    
    // Filter
    const filtered = DRUGS.filter(d => 
        d.standard_dilution.syringe_ml === state.syringeSize &&
        (d.name.toLowerCase().includes(state.search.toLowerCase()) || 
        d.type.toLowerCase().includes(state.search.toLowerCase()))
    );

    if (filtered.length === 0) {
        drugList.innerHTML = `
            <div style="text-align:center; padding:3rem 1rem; color:#94a3b8;">
                <div style="font-size:2rem; margin-bottom:1rem;">üíâ</div>
                <div style="font-weight:600">Nenhuma dilui√ß√£o para ${state.syringeSize}ml</div>
            </div>`;
        return;
    }

    filtered.forEach(drug => {
        const card = document.createElement('div');
        const isExpanded = state.expandedCards.has(drug.id);
        card.className = `card ${isExpanded ? 'expanded' : ''}`;
        card.id = `card-${drug.id}`;
        
        if (state.doses[drug.id] === undefined) {
             state.doses[drug.id] = drug.default_dose.min !== null ? drug.default_dose.min : '';
        }

        const currentDose = state.doses[drug.id];
        const rate = calculateRate(currentDose, state.weight, drug);
        const warning = drug.warning ? `<span class="warning-tag">‚ö†Ô∏è ${drug.warning}</span>` : '';
        
        // Soft Alert Logic
        const isHighDose = drug.default_dose.max && currentDose && currentDose > drug.default_dose.max;
        
        // Prep Logic (Explicit Volume)
        const numAmps = drug.standard_dilution.num_ampoules || (drug.standard_dilution.drug_volume_ml / drug.presentation.ampoule_ml);
        const ampText = numAmps === 1 ? 'Ampola' : 'Ampolas'; // Unused var kept for potential future use

        card.innerHTML = `
            <div class="card-header" onclick="toggleCard('${drug.id}')">
                <div>
                    <div>
                        <span class="badge ${drug.type}">${drug.type}</span>
                        ${warning}
                    </div>
                    <div class="drug-name">${drug.name}</div>
                    
                    ${!isExpanded && rate > 0 ? `
                        <div style="margin-top:0.5rem; display:flex; align-items:center; gap:0.5rem; font-family:monospace; font-weight:700; color:var(--samu-orange);">
                            <span style="font-size:1.25rem;">${formatNumber(rate)}</span>
                            <span style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">mL/h</span>
                            ${isHighDose ? '<span style="font-size:0.6rem; color: #c2410c; background: #fff7ed; padding:2px 6px; border-radius:99px;">ALERTA</span>' : ''}
                        </div>
                    ` : ''}
                </div>
                <div style="color:var(--text-muted)">${isExpanded ? '‚ñ≤' : '‚ñº'}</div>
            </div>

            <div class="card-content">
                <div class="info-grid">
                    <div class="info-box">
                        <span class="info-label">Seringa Total</span>
                        <span class="info-val">${drug.standard_dilution.syringe_ml} mL</span>
                    </div>
                    <div class="info-box">
                        <span class="info-label">Concentra√ß√£o</span>
                        <span class="info-val large">${drug.standard_dilution.final_concentration_mcg_ml}</span>
                        <span style="font-size:0.7rem; color:var(--text-muted);">mcg/mL</span>
                    </div>
                </div>

                <div style="margin: 0 1rem 1rem 1rem; padding: 0.75rem; background: #f0f9ff; border: 1px dashed #bae6fd; border-radius: 0.375rem; font-size: 0.8rem;">
                    <div style="color: #0369a1; font-weight: 700; font-size: 0.65rem; text-transform: uppercase; margin-bottom: 0.5rem; border-bottom: 1px solid #e0f2fe; padding-bottom: 0.25rem;">COMO PREPARAR</div>
                    <div style="display: flex; align-items: center; justify-content: space-around;">
                        <div style="text-align: center;">
                            <div style="font-weight: 800; font-size: 1.25rem; color: #0c4a6e; line-height: 1;">${drug.standard_dilution.drug_volume_ml}</div>
                            <div style="font-size: 0.6rem; color: #0284c7; text-transform: uppercase; font-weight:700;">ml da Droga</div>
                        </div>
                        <div style="color: #94a3b8; font-weight: 300; font-size: 1.5rem;">+</div>
                        <div style="text-align: center;">
                            <div style="font-weight: 800; font-size: 1.25rem; color: #0c4a6e; line-height: 1;">${drug.standard_dilution.diluent_volume_ml}</div>
                            <div style="font-size: 0.6rem; color: #0284c7; text-transform: uppercase; font-weight:700;">ml Diluente</div>
                        </div>
                        <div style="color: #94a3b8; font-weight: 300; font-size: 1.5rem;">=</div>
                        <div style="text-align: center;">
                            <div style="font-weight: 800; font-size: 1.25rem; color: #0c4a6e; line-height: 1;">${drug.standard_dilution.syringe_ml}</div>
                            <div style="font-size: 0.6rem; color: #0284c7; text-transform: uppercase; font-weight:700;">ml Total</div>
                        </div>
                    </div>
                </div>

                <div class="calc-area">
                    <div class="dose-input-group">
                        <label class="info-label" style="margin-bottom:0.5rem">Dose Prescrita</label>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <input type="number" 
                                class="dose-input ${isHighDose ? 'high-dose' : ''}" 
                                value="${currentDose}" 
                                oninput="updateDose('${drug.id}', this.value)"
                                step="any"
                                placeholder="${drug.default_dose.min || 0}">
                            <span style="font-size:0.75rem; font-weight:700; color:var(--text-muted); width:4rem;">
                                ${drug.default_dose.unit}
                            </span>
                        </div>
                        ${isHighDose ? `<div class="high-dose-badge">‚ö†Ô∏è Dose acima do padr√£o (${drug.default_dose.max})</div>` : ''}
                    </div>

                    ${(rate > 0 || String(rate) === '0' && currentDose > 0) ? `
                        <div class="result-box">
                            <div>
                                <div class="result-label">Vaz√£o em Bomba</div>
                            </div>
                            <div style="text-align:right">
                                <span class="result-val">${formatNumber(rate)}</span>
                                <span class="result-unit">mL/h</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        drugList.appendChild(card);
    });
}

// --- ACTIONS ---
window.toggleCard = (id) => {
    if (state.expandedCards.has(id)) {
        state.expandedCards.delete(id);
    } else {
        state.expandedCards.add(id);
    }
    renderDrugList(); 
};

window.updateDose = (id, value) => {
    state.doses[id] = value; 
    renderDrugList(); 
    
    setTimeout(() => {
        const input = document.querySelector(`#card-${id} input`);
        if(input) input.focus();
    }, 0);
};

function renderAllCalculations() {
    renderDrugList();
}

// Start
renderDrugList();
</script>
</body>
</html>
